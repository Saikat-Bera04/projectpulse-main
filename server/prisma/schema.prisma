generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - stores both GitHub OAuth users and regular users
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  firstName       String?
  lastName        String?
  password        String?   // For email/password auth (hashed)
  
  // GitHub OAuth fields
  githubId        String?   @unique
  githubUsername  String?   @unique
  githubAccessToken String?
  avatarUrl       String?
  bio             String?
  location        String?
  company         String?
  website         String?
  
  // User profile fields
  role            String?   @default("developer")
  skills          String[]  @default([])
  interests       String[]  @default([])
  availability    String?   @default("flexible") // full-time, part-time, flexible
  experience      String?   // junior, mid, senior
  
  // Vector embedding for AI matching (empty array if not generated)
  embedding       Float[]   @default([])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLogin       DateTime?
  
  // Relations
  ownedProjects   Project[] @relation("ProjectOwner")
  projectMembers  ProjectMember[]
  tasks           Task[]
  comments        Comment[]
  activities      Activity[]
  notifications   Notification[]
  sentInvites     TeamInvite[] @relation("InviteSender")
  receivedInvites TeamInvite[] @relation("InviteReceiver")
  repositories    Repository[]
  
  @@index([githubId])
  @@index([email])
  @@index([githubUsername])
}

// Project model
model Project {
  id              String    @id @default(cuid())
  name            String
  description     String?
  
  // GitHub integration
  githubRepoId    String?   @unique
  githubRepoUrl   String?
  githubRepoName  String?
  repoOwner       String?
  repoPrivate     Boolean   @default(false)
  lastSyncedAt    DateTime?
  
  status          String    @default("active") // active, completed, archived
  progress        Int       @default(0) // 0-100
  
  // Project metadata
  tech            String[]  @default([])
  category        String?
  startDate       DateTime?
  endDate         DateTime?
  
  ownerId         String
  owner           User      @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  members         ProjectMember[]
  tasks           Task[]
  activities      Activity[]
  invites         TeamInvite[]
  
  @@index([ownerId])
  @@index([githubRepoId])
  @@index([status])
}

// Project members and their roles
model ProjectMember {
  id          String    @id @default(cuid())
  role        String    @default("member") // owner, admin, member, viewer
  joinedAt    DateTime  @default(now())
  
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// Task model for Kanban board
model Task {
  id              String    @id @default(cuid())
  title           String
  description     String?
  
  status          String    @default("todo") // todo, in_progress, done
  priority        String    @default("medium") // low, medium, high
  type            String    @default("feature") // feature, bug, docs, improvement
  column          String    @default("To Do") // To Do, In Progress, Done
  
  // GitHub issue integration
  githubIssueId   Int?
  githubIssueUrl  String?
  syncedWithGitHub Boolean  @default(false)
  
  dueDate         DateTime?
  completedAt     DateTime?
  
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  assigneeId      String?
  assignee        User?     @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  comments        Comment[]
  activities      Activity[]
  
  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([githubIssueId])
}

// Comments on tasks
model Comment {
  id          String    @id @default(cuid())
  content     String
  
  taskId      String
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([taskId])
  @@index([userId])
}

// Activity log for projects and tasks
model Activity {
  id          String    @id @default(cuid())
  type        String    // task_created, task_updated, task_completed, comment_added, member_added, etc.
  description String
  metadata    Json?     // Additional data about the activity
  
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  taskId      String?
  task        Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@index([projectId])
  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
}

// Team invitations
model TeamInvite {
  id          String    @id @default(cuid())
  status      String    @default("pending") // pending, accepted, rejected
  message     String?
  
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  senderId    String
  sender      User      @relation("InviteSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId  String
  receiver    User      @relation("InviteReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  respondedAt DateTime?
  
  @@index([projectId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}

// Notifications
model Notification {
  id          String    @id @default(cuid())
  type        String    // task_assigned, comment_mention, invite_received, etc.
  title       String
  message     String
  read        Boolean   @default(false)
  link        String?
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// GitHub repositories (cached data)
model Repository {
  id              String    @id @default(cuid())
  githubId        Int       @unique
  name            String
  fullName        String
  description     String?
  url             String
  language        String?
  private         Boolean   @default(false)
  fork            Boolean   @default(false)
  stars           Int       @default(0)
  forks           Int       @default(0)
  openIssues      Int       @default(0)
  updatedAt       DateTime
  
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  lastFetchedAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([githubId])
}

// AI Match scores for team matching
model MatchScore {
  id          String    @id @default(cuid())
  user1Id     String
  user2Id     String
  score       Float     // 0-100 match percentage
  factors     Json?     // Breakdown of match factors
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@index([score])
}
